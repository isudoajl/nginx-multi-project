# Security settings
# Rate limiting zone - limits clients to 10 requests per second
limit_req_zone $binary_remote_addr zone=projectlimit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=projectconn:10m;

# Apply rate limiting to all locations
limit_req zone=projectlimit burst=20 nodelay;
limit_conn projectconn 20;

# Block common malicious bot user agents
map $http_user_agent $bad_bot {
    default 0;
    ~*(nmap|nikto|sqlmap|arachni|dirbuster|gobuster|w3af|nessus|masscan|ZmEu|zgrab) 1;
    ~*(python-requests|python-urllib|python-httpx|go-http-client|curl|wget) 1;
    "" 1; # Empty user agent
}

# Block requests with unusual HTTP methods
map $request_method $method_allowed {
    default 1;
    ~*(TRACE|TRACK|DEBUG) 0;
}

# Block WordPress and common CMS scanning
location ~* \.(php|asp|aspx|jsp|cgi)$ {
    return 444;
}

# Block WordPress specific patterns
location ~* wp-(admin|includes|content|login) {
    return 444;
}

# Block common vulnerability scanning paths
location ~* \.(git|svn|hg|bzr|cvs|env)(/.*)?$ {
    return 444;
}

location ~* /(xmlrpc\.php|wp-config\.php|config\.php|configuration\.php|config\.inc\.php|settings\.php|settings\.inc\.php|\.env|\.git) {
    return 444;
}

# Main location block for handling bad bots and unusual methods
location / {
    # Return 444 for bad bots and unusual methods
    if ($bad_bot = 1) {
        return 444;
    }

    if ($method_allowed = 0) {
        return 444;
    }
    
    # Pass all other requests to the next handler
    try_files $uri $uri/ =404;
}
